# Chameleon System CmsCoreLogBundle

**Deprecated since Chameleon System 6.3.**  
It is recommended to use `Psr\Log\LoggerInterface` with Monolog directly.

Provides database-based logging for Chameleon System core components.
Stores log entries in the `pkg_cms_core_log` table, enriched with request and session metadata.
Includes Monolog handlers, processors, cleanup cronjob, CLI command, and backend list manager.

## Features

* Monolog database handler (`cmsPkgCore.logHandler.database`)
* Monolog processors:
  * `chameleon_system_cms_core_log.processor.request_id`
  * `chameleon_system_cms_core_log.processor.session_id`
  * Standard `WebProcessor` and `IntrospectionProcessor`
* TPkgCmsCoreLog wrapper services (`cmsPkgCore.logChannel.*`) for PSR-3 logging with metadata
* CLI command `log:show` to query and display log entries
* Cleanup cronjob (`chameleon_system_cms_core_log.cronjob.cleanup_cronjob`) to purge old logs
* Backend list manager (`TCMSListManagerLogEntries`) with log level filter
* Per-channel retention settings via `pkg_cms_core_log_channel` table

## Requirements
* PHP 8.2+
* Symfony 6.4 components (`HttpFoundation`, `Console`, etc.)
* Monolog Bundle

## Installation
Install via Composer:
```bash
composer require chameleon-system/pkgcmscorelog
```
Register the bundle in `config/bundles.php` (if not auto-registered):
```php
return [
    // ...
    ChameleonSystem\\CmsCoreLogBundle\\ChameleonSystemCmsCoreLogBundle::class => ['all' => true],
];
```
Ensure the Monolog Bundle and Doctrine DBAL are installed and configured.

## Configuration
Configure Monolog to use the provided handlers in `config/packages/monolog.yaml`:
```yaml
monolog:
  handlers:
    # Store core logs in the database
    core_db:
      type: service
      id: cmsPkgCore.logHandler.database
      channels: ['core']

    # Optional: buffer and write on errors
    core_fingerscrossed:
      type: service
      id: cmsPkgCore.logHandler.fingerscrossed
      channels: ['core']

    # Optional: local file logging
    core_file:
      type: service
      id: cmsPkgCore.logHandler.files
      channels: ['core']
```
Wrap loggers with TPkgCmsCoreLog services for metadata:
```yaml
services:
  cmsPkgCore.logChannel.standard:
    class: TPkgCmsCoreLog
    arguments: ['@monolog.logger.core']
```
For a full list of service IDs and classes, see `Resources/config/services.xml`.

## Usage
### Logging in code
Inject or fetch the TPkgCmsCoreLog service:
```php
/** @var TPkgCmsCoreLog $logger */
$logger = $container->get('cmsPkgCore.logChannel.standard');
$logger->info('User login', __FILE__, __LINE__, ['userId' => $user->getId()]);
```
Alternatively, use PSR-3 `LoggerInterface` directly:
```php
public function __construct(LoggerInterface $logger)
{
    $logger->error('Something went wrong');
}
```

### Viewing logs via CLI
```bash
bin/console log:show \
  --channel="core%" \
  --level=200 \
  --number=20 \
  --details=med \
  --page=0 \
  --sort=desc
```
Options:
* `--channel` (`-c`): Filter by log channel (supports `%` wildcard)
* `--level` (`-l`): Minimum level (100=DEBUG,...,600=EMERGENCY)
* `--number`: Number of entries to show (default 10)
* `--details`: Output verbosity: `min`, `med`, `max`, `single`
* `--cmsident`: Show a single request identifier
* `--ip`: Filter by client IP
* `--page`: Pagination offset
* `--sort`: `asc` or `desc`

### Cleanup cronjob
The `TPkgCmsCoreLogCleanupCronJob` service (`chameleon_system_cms_core_log.cronjob.cleanup_cronjob`)
deletes old log entries based on channel settings:
* Default retention: 30 days for warnings and above, 7 days for notices and below
* Customize per channel via the `pkg_cms_core_log_channel.fieldMaxLogAgeInSeconds` field
Execute cronjobs:
```bash
bin/console chameleon:cron
```

### Backend list manager
In the CMS backend, access "Log Entries" to view logs via `TCMSListManagerLogEntries`,
with a dropdown to filter by log level.

## Database Schema and Migrations
The bundle writes to:
* `pkg_cms_core_log`: Log entries
* `pkg_cms_core_log_channel`: Channel retention settings
Apply migrations:
```bash
bin/console doctrine:migrations:migrate
```
or use the Chameleon System migration runner.

## Testing
Run PHPUnit tests for Monolog processors:
```bash
vendor/bin/phpunit src/CmsCoreLogBundle/Tests
```

## License
This bundle is licensed under the [MIT license](../../LICENSE).

## Disclaimer

This documentation was autogenerated with AI.